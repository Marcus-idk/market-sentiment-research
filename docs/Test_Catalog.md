# Test Catalog — Complete Test Inventory

This file is autogenerated by `tools/generate_test_catalog.py`. Do not edit by hand.

## Tag Legend
- [network] — Performs real HTTP calls; requires network and API keys.
- [shared] — Shared behavior suite applied across implementations.
- [async] — Module-level asyncio usage in this file.
- [integration] — Marks cross-module or external-integration suites.

### `tests/__init__.py`
- Purpose: Tests package for Market Sentiment Analyzer.
- Tests: (none)

### `tests/conftest.py`
- Purpose: Project-wide pytest fixtures and utilities.
- Fixtures:
  - `temp_db_path` - Yield path to a temporary SQLite database and clean it up afterwards.
  - `temp_db` - Initialize a temporary Market Sentiment Analyzer database and yield its path.
  - `mock_http_client` - Provide a factory that returns a mocked httpx.AsyncClient.
- Helpers: `cleanup_sqlite_artifacts`
- Tests: (none)

### `tests/factories/__init__.py`
- Purpose: Shared factory helpers for building data model instances in tests.
- Tests: (none)

### `tests/factories/models.py`
- Purpose: Shared factories for building data model instances in tests.
- Helpers: `make_news_item`, `make_news_entry`, `make_price_data`, `make_analysis_result`, `make_holdings`, `make_social_discussion`
- Tests: (none)

### `tests/integration/conftest.py`
- Purpose: Shared pytest configuration for integration tests.
- Tags: [integration]
- Fixtures:
  - `finnhub_settings` - Load FinnhubSettings from the environment or skip when unavailable.
  - `reddit_settings` - Load RedditSettings from the environment or skip when unavailable.
- Tests: (none)

### `tests/integration/data/providers/test_finnhub_live.py`
- Purpose: Live integration tests for Finnhub providers using the real API.
- Tags: [async] [integration] [network]
- Tests:
  - `test_live_quote_fetch` - Test fetching real quote data from Finnhub API
  - `test_live_news_fetch` - Test fetching real news data from Finnhub API
  - `test_live_multiple_symbols` - Test fetching data for multiple symbols
  - `test_live_error_handling` - Test error handling with invalid symbol via price provider.

### `tests/integration/data/providers/test_reddit_live.py`
- Purpose: Live integration tests for Reddit social provider using the real API.
- Tags: [async] [integration] [network]
- Tests:
  - `test_live_validate_connection` - Test validating Reddit credentials against the live API.
  - `test_live_discussions_fetch` - Test fetching recent discussions for a real symbol.

### `tests/integration/data/test_decimal_precision.py`
- Purpose: Validate exact Decimal precision through the storage pipeline.
- Tags: [integration]
- Tests:
  **TestDecimalPrecision**
  - `test_financial_precision_preservation` - Preserves Decimal precision across roundtrip, including edge cases.

### `tests/integration/data/test_dedup_news.py`
- Purpose: Validate URL normalization and cross-provider news deduplication.
- Tags: [integration]
- Tests:
  **TestNewsDeduplication**
  - `test_cross_provider_deduplication` - URL normalization enables deduplication across provider variants.

### `tests/integration/data/test_roundtrip_e2e.py`
- Purpose: End-to-end data roundtrip tests validating storage, retrieval, and field preservation.
- Tags: [integration]
- Tests:
  **TestDataRoundtrip**
  - `test_complete_data_roundtrip` - Store and retrieve all models, validating field preservation and timezone conversion.
  - `test_cross_model_data_consistency` - Verify data consistency when the same symbol appears across all models.
  - `test_upsert_invariants` - Verify upsert operations preserve created_at while advancing update timestamps.
  - `test_duplicate_price_prevention` - Verify INSERT OR IGNORE prevents duplicate price data (same symbol + timestamp).

### `tests/integration/data/test_schema_constraints.py`
- Purpose: Validate schema CHECK constraints and transaction rollback behavior.
- Tags: [integration]
- Tests:
  **TestSchemaConstraints**
  - `test_transaction_rollback_on_constraint_violation` - Constraint violations raise and do not corrupt DB; valid ops succeed.

### `tests/integration/data/test_timezone_pipeline.py`
- Purpose: Validate UTC timezone handling end-to-end across the data pipeline.
- Tags: [integration]
- Tests:
  **TestTimezonePipeline**
  - `test_timezone_consistency` - UTC normalization in models, storage ISO 'Z', retrieval, and cross-model consistency.

### `tests/integration/data/test_wal_sqlite.py`
- Purpose: Validate SQLite WAL mode and concurrent operations under realistic load.
- Tags: [integration]
- Tests:
  **TestWALSqlite**
  - `test_wal_mode_functionality` - WAL mode is enabled and functional with file-backed DB.
  - `test_concurrent_operations_with_wal` - WAL allows concurrent read/write without lock errors and maintains consistency.

### `tests/integration/llm/conftest.py`
- Purpose: Fixtures and provider specs for LLM integration contract tests.
- Tags: [integration]
- Fixtures:
  - `provider_spec` - ProviderSpec fixture for LLM integration contract tests.
- Helpers: `ProviderSpec`
- Tests: (none)

### `tests/integration/llm/helpers.py`
- Purpose: Helper functions for LLM integration tests.
- Tags: [integration]
- Helpers: `make_base64_blob`, `extract_hex64`, `fetch_featured_wiki`, `normalize_title`
- Tests: (none)

### `tests/integration/llm/shared/test_llm_code_tools_shared.py`
- Purpose: Contract tests for LLM code-execution tooling.
- Tags: [async] [integration] [network] [shared]
- Tests:
  - `test_code_tools_enabled_matches_expected_digest` - Test code tools enabled matches expected digest.
  - `test_code_tools_disabled_does_not_match_digest` - Test code tools disabled does not match digest.

### `tests/integration/llm/shared/test_llm_connection_shared.py`
- Purpose: Contract tests for basic LLM connectivity.
- Tags: [async] [integration] [network] [shared]
- Tests:
  - `test_provider_validates_connection` - Test provider validates connection.
  - `test_provider_generates_basic_response` - Test provider generates basic response.

### `tests/integration/llm/shared/test_llm_web_search_shared.py`
- Purpose: Contract tests for LLM web-search tooling.
- Tags: [async] [integration] [network] [shared]
- Tests:
  - `test_web_search_enabled_returns_expected_title` - Test web search enabled returns expected title.
  - `test_web_search_disabled_does_not_find_title` - Test web search disabled does not find title.

### `tests/unit/analysis/test_news_importance.py`
- Purpose: Unit tests for the news importance stub.
- Tests:
  - `test_label_importance_marks_all_entries_true` - Stub marks every news entry as important.
  - `test_label_importance_handles_empty_list` - Empty input returns empty list.

### `tests/unit/analysis/test_urgency_detector.py`
- Purpose: Unit tests for urgency detection module.
- Tests:
  - `test_detect_news_urgency_returns_empty_list` - News detector stub returns empty list for populated entries.
  - `test_detect_news_urgency_handles_empty_list` - News detector stub handles empty input.
  - `test_detect_news_urgency_extracts_text_from_headline_and_content` - News detector accesses headline/content safely even when content is None.
  - `test_detect_social_urgency_handles_empty_and_content_none` - Social detector stub returns empty and tolerates missing content.

### `tests/unit/config/llm/test_gemini.py`
- Purpose: GeminiSettings provider-specific tests (shared checks elsewhere).
- Tests: (none)

### `tests/unit/config/llm/test_openai.py`
- Purpose: OpenAISettings provider-specific tests (shared checks elsewhere).
- Tests: (none)

### `tests/unit/config/providers/test_finnhub_settings.py`
- Purpose: FinnhubSettings provider-specific tests (shared checks elsewhere).
- Tests: (none)

### `tests/unit/config/providers/test_reddit_settings.py`
- Purpose: RedditSettings provider-specific env loading tests.
- Tests:
  **TestRedditSettings**
  - `test_from_env_success` - Loads all required fields and keeps default retry config.
  - `test_from_env_missing_client_id` - Missing client id raises ValueError.
  - `test_from_env_missing_client_secret` - Missing client secret raises ValueError.
  - `test_from_env_missing_user_agent` - Missing user agent raises ValueError.
  - `test_from_env_strips_whitespace` - Whitespace around values is stripped.

### `tests/unit/config/shared/test_settings_shared.py`
- Purpose: Shared env loading/validation across Finnhub, OpenAI, Gemini.
- Tags: [shared]
- Fixtures:
  - `settings_spec` - Parametrized settings specification for shared env-loading contract tests.
- Tests:
  **TestSettingsShared**
  - `test_from_env_success` - Test successful loading when API key is set
  - `test_from_env_missing_key` - Raises ValueError when API key is not set
  - `test_from_env_empty_key` - Raises ValueError when API key is empty string
  - `test_from_env_whitespace_key` - Raises ValueError when API key is only whitespace
  - `test_from_env_strips_whitespace` - Test that whitespace is stripped from API key
  - `test_from_env_custom_env_dict` - Test using custom environment dictionary instead of os.environ

### `tests/unit/config/test_config_retry.py`
- Purpose: Retry config tests: defaults, immutability, custom values.
- Tests:
  **TestLLMRetryConfig**
  - `test_custom_values` - Test LLMRetryConfig can be instantiated with custom values
  - `test_partial_custom_values` - Test LLMRetryConfig with some custom values and some defaults
  - `test_immutability` - Test LLMRetryConfig is frozen (immutable)
  - `test_default_instance` - Test DEFAULT_LLM_RETRY instance exists with correct values
  - `test_default_instance_immutable` - Test DEFAULT_LLM_RETRY instance cannot be modified

  **TestDataRetryConfig**
  - `test_custom_values` - Test DataRetryConfig can be instantiated with custom values
  - `test_partial_custom_values` - Test DataRetryConfig with some custom values and some defaults
  - `test_immutability` - Test DataRetryConfig is frozen (immutable)
  - `test_default_instance` - Test DEFAULT_DATA_RETRY instance exists with correct values
  - `test_default_instance_immutable` - Test DEFAULT_DATA_RETRY instance cannot be modified

  **TestRetryBusinessRules**
  - `test_different_timeouts` - Test that LLM and Data configs have different default timeouts

### `tests/unit/data/models/test_holdings_and_social_models.py`
- Purpose: Holdings and social discussion model validation tests.
- Tests:
  **TestHoldings**
  - `test_holdings_symbol_uppercasing` - Test symbol is automatically uppercased
  - `test_holdings_financial_values_positive` - Test quantity > 0, break_even_price > 0, total_cost > 0
  - `test_holdings_decimal_precision` - Test all financial fields maintain Decimal precision
  - `test_holdings_timezone_normalization` - Test timezone normalization for created_at and updated_at
  - `test_holdings_symbol_validation` - Test symbol stripping and empty validation
  - `test_holdings_notes_trimming` - Test notes field trimming when provided

  **TestSocialDiscussion**
  - `test_required_fields_raise_value_error` - Empty or invalid fields raise ValueError.
  - `test_non_datetime_published_raises` - Non-datetime published values raise ValueError.
  - `test_normalization_strips_and_uppercases` - Whitespace trimmed; symbol uppercased; published normalized to UTC.

### `tests/unit/data/models/test_news_models.py`
- Purpose: News-related data model validation tests.
- Tests:
  **TestNewsItem**
  - `test_newsitem_valid_creation` - Valid NewsItem requires url/headline/source/news_type.
  - `test_newsitem_url_validation_accepts_http` - URL must allow http/https.
  - `test_newsitem_url_validation_rejects_non_http` - URL must be http(s).
  - `test_newsitem_empty_field_validation` - headline and source required after strip().
  - `test_newsitem_news_type_variants` - news_type accepts enum instances or exact strings.
  - `test_newsitem_timezone_normalization` - Naive datetimes converted to UTC.

  **TestNewsEntry**
  - `test_newsentry_symbol_uppercasing_and_passthrough` - Test newsentry symbol uppercasing and passthrough.
  - `test_newsentry_is_important_accepts_bool_or_none` - Test newsentry is important accepts bool or none.
  - `test_newsentry_requires_non_empty_symbol` - Test newsentry requires non empty symbol.
  - `test_newsentry_invalid_is_important_value` - Test newsentry invalid is important value.

  **TestNewsSymbol**
  - `test_newssymbol_valid_creation` - Test newssymbol valid creation.
  - `test_newssymbol_importance_bool_conversion` - Test newssymbol importance bool conversion.
  - `test_newssymbol_invalid_inputs_raise` - Test newssymbol invalid inputs raise.

### `tests/unit/data/models/test_price_and_analysis_models.py`
- Purpose: Price and analysis model validation tests.
- Tests:
  **TestPriceData**
  - `test_pricedata_symbol_uppercasing` - Test symbol is automatically uppercased
  - `test_pricedata_price_must_be_positive` - price must be > 0.
  - `test_pricedata_volume_validation` - Test volume >= 0 validation (can be None)
  - `test_pricedata_session_enum_validation` - Test Session enum validation
  - `test_pricedata_decimal_precision` - Test Decimal type preservation
  - `test_pricedata_timezone_normalization` - Test timestamp timezone normalization
  - `test_pricedata_symbol_validation` - Test symbol stripping and empty validation

  **TestAnalysisResult**
  - `test_analysisresult_symbol_uppercasing` - Test symbol is automatically uppercased
  - `test_analysisresult_json_validation` - Test result_json must be valid JSON object
  - `test_analysisresult_confidence_score_validation` - Test confidence_score range validation
  - `test_analysisresult_enum_validation` - Test AnalysisType and Stance enum validation
  - `test_analysisresult_timezone_normalization` - Test timezone normalization for last_updated and created_at
  - `test_analysisresult_symbol_validation` - Test symbol stripping and empty validation
  - `test_analysisresult_empty_string_validation` - Test model_name and result_json empty string validation

### `tests/unit/data/providers/conftest.py`
- Purpose: Common fixtures for data provider contract tests.
- Fixtures:
  - `provider_spec_company` - Parametrized company-news provider spec for Finnhub.
  - `provider_spec_macro` - Parametrized macro-news provider spec for Finnhub.
  - `provider_spec_prices` - Price provider spec for Finnhub used by shared price contract tests.
  - `client_spec` - HTTP client spec for Finnhub client.
- Helpers: `CompanyProviderSpec`, `MacroProviderSpec`, `PriceProviderSpec`, `ClientSpec`, `_finnhub_settings`
- Tests: (none)

### `tests/unit/data/providers/shared/test_client_shared.py`
- Purpose: Shared behavior tests for provider API clients.
- Tags: [async] [shared]
- Tests:
  **TestClientShared**
  - `test_get_builds_url_and_injects_auth` - Test get builds url and injects auth.
  - `test_get_handles_none_params` - Test get handles none params.
  - `test_validate_connection_success` - Test validate connection success.
  - `test_validate_connection_failure_returns_false` - Test validate connection failure returns false.
  - `test_get_respects_custom_base_url_override` - Ensure clients honor a non-default base_url from settings

### `tests/unit/data/providers/shared/test_news_company_shared.py`
- Purpose: Shared behavior tests for company news providers.
- Tags: [async] [shared]
- Tests:
  **TestNewsCompanyShared**
  - `test_validate_connection_success` - Test validate connection success.
  - `test_validate_connection_failure` - Test validate connection failure.
  - `test_parses_valid_article` - Test parses valid article.
  - `test_skips_missing_headline` - Test skips missing headline.
  - `test_skips_missing_url` - Test skips missing url.
  - `test_skips_invalid_timestamp` - Test skips invalid timestamp.
  - `test_filters_articles_with_buffer` - Test filters articles with buffer.
  - `test_date_window_params_with_since` - Test date window params with since.
  - `test_date_window_params_without_since` - Test date window params without since.
  - `test_symbol_normalization_uppercases` - Test symbol normalization uppercases.
  - `test_summary_copied_to_content` - Test summary copied to content.
  - `test_per_symbol_error_isolation` - Test per symbol error isolation.
  - `test_structural_error_logs_warning_and_skips` - Test structural error logs warning and skips.
  - `test_empty_response_returns_empty_list` - Test empty response returns empty list.
  - `test_symbol_since_map_takes_precedence` - Test symbol since map takes precedence.
  - `test_symbol_cursor_falls_back_to_global_or_none` - Test symbol cursor falls back to global or none.

### `tests/unit/data/providers/shared/test_news_macro_shared.py`
- Purpose: Shared behavior tests for macro news providers.
- Tags: [async] [shared]
- Tests:
  **TestNewsMacroShared**
  - `test_validate_connection_success` - Test validate connection success.
  - `test_validate_connection_failure` - Test validate connection failure.
  - `test_maps_related_symbols` - Test maps related symbols.
  - `test_falls_back_to_market_when_no_related` - Test falls back to market when no related.
  - `test_filters_buffer_time_when_bootstrap` - Test filters buffer time when bootstrap.
  - `test_invalid_articles_are_skipped` - Test invalid articles are skipped.
  - `test_structural_error_raises` - Test structural error raises.
  - `test_empty_watchlist_falls_back_to_market` - Test empty watchlist falls back to market.
  - `test_structural_error_non_dict_response` - Test structural error non dict response.
  - `test_parse_exception_skips_article_and_continues` - Test parse exception skips article and continues.
  - `test_invalid_timestamp_skips_article` - Test invalid timestamp skips article.
  - `test_newsitem_validation_failure_skips_article` - Test newsitem validation failure skips article.
  - `test_newsentry_validation_failure_skips_symbol` - Test newsentry validation failure skips symbol.

### `tests/unit/data/providers/shared/test_prices_shared.py`
- Purpose: Shared behavior tests for price data providers.
- Tags: [async] [shared]
- Tests:
  **TestPricesShared**
  - `test_validate_connection_success` - Test validate connection success.
  - `test_validate_connection_failure` - Test validate connection failure.
  - `test_decimal_conversion` - Test decimal conversion.
  - `test_classifies_session` - Test classifies session.
  - `test_rejects_negative_price` - Test rejects negative price.
  - `test_rejects_zero_price` - Test rejects zero price.
  - `test_rejects_string_price` - Test rejects string price.
  - `test_rejects_missing_price_field` - Test rejects missing price field.
  - `test_timestamp_fallback_when_missing` - Test timestamp fallback when missing.
  - `test_timestamp_fallback_when_invalid` - Test timestamp fallback when invalid.
  - `test_error_isolation_per_symbol` - Test error isolation per symbol.
  - `test_non_dict_quote_skipped` - Test non dict quote skipped.

### `tests/unit/data/providers/test_finnhub_macro.py`
- Purpose: Finnhub-specific macro news tests that complement contract coverage.
- Tags: [async]
- Fixtures:
  - `macro_provider` - Return a FinnhubMacroNewsProvider configured with sample symbols.
- Tests:
  **TestFinnhubMacroProviderSpecific**
  - `test_fetch_incremental_includes_min_id_param` - Test fetch incremental includes min id param.
  - `test_last_fetched_max_id_advances_only_on_newer_ids` - Test last fetched max id advances only on newer ids.
  - `test_fetch_incremental_paginates_with_min_id` - Test fetch incremental paginates with min id.
  - `test_fetch_incremental_stops_at_bootstrap_cutoff` - Test fetch incremental stops at bootstrap cutoff.

### `tests/unit/data/providers/test_finnhub_news.py`
- Purpose: Finnhub-specific company news tests (contract coverage handled elsewhere).
- Tags: [async]
- Tests:
  **TestFinnhubNewsProviderSpecific**
  - `test_fetch_incremental_with_no_symbols_returns_empty_list` - Test fetch incremental with no symbols returns empty list.

### `tests/unit/data/providers/test_finnhub_prices.py`
- Purpose: Finnhub-specific price provider tests (shared behaviors covered by shared tests).
- Tags: [async]
- Fixtures:
  - `price_provider` - Return a FinnhubPriceProvider with a test API key and no symbols.
- Tests:
  **TestFinnhubPriceProviderSpecific**
  - `test_fetch_incremental_with_no_symbols_returns_empty_list` - Test fetch incremental with no symbols returns empty list.

### `tests/unit/data/providers/test_reddit_client.py`
- Purpose: RedditClient wiring and validation behavior.
- Tests:
  **TestRedditClient**
  - `test_init_sets_read_only_and_creds` - praw.Reddit called with provided creds and read_only enabled.
  - `test_validate_connection_success` - Returns True when reddit.user.me is truthy.
  - `test_validate_connection_praw_error_logs_and_returns_false` - PrawcoreException returns False and logs warning.
  - `test_validate_connection_generic_error_returns_false` - Generic errors also return False and warn.

### `tests/unit/data/providers/test_reddit_social.py`
- Purpose: RedditSocialProvider incremental fetching and parsing.
- Tags: [async]
- Fixtures:
  - `settings` - Return RedditSettings with test credentials for unit tests.
  - `immediate_to_thread` - Patch asyncio.to_thread to execute callables immediately during tests.
- Helpers: `_freeze_datetime`, `FakeComments`
- Tests:
  **TestRedditSocialProviderBasics**
  - `test_symbol_normalization_uppercases_and_filters` - Normalize symbols by stripping whitespace and uppercasing non-empty entries.
  - `test_validate_connection_delegates_to_client` - Ensure validate_connection delegates to the underlying client once.

  **TestFetchIncremental**
  - `test_fetch_incremental_empty_symbols_returns_empty` - Return an empty list when no symbols are configured.
  - `test_fetch_incremental_bootstrap_uses_week_filter` - Use the bootstrap time filter and first-run window when no cursor is set.
  - `test_fetch_incremental_cursor_uses_hour_with_overlap` - Use incremental time filter and overlap window when a symbol cursor exists.
  - `test_resolve_symbol_cursor_prefers_symbol_map_over_global` - Prefer per-symbol cursor over global since when resolving start time.
  - `test_fetch_incremental_praw_error_skips_symbol_not_all` - Skip only symbols that raise PrawcoreException and keep others.

  **TestParseSubmission**
  - `test_parse_submission_valid_returns_discussion` - Parse a valid submission into a SocialDiscussion instance.
  - `test_parse_submission_invalid_returns_none` - Return None for malformed or incomplete Reddit submissions.
  - `test_parse_submission_returns_none_when_before_start` - Return None when a submission is older than the incremental start time.

  **TestBuildContent**
  - `test_build_content_combines_selftext_and_comments` - Combine selftext and non-empty comment bodies into a single content string.
  - `test_build_content_empty_returns_none` - Return None when both selftext and comments are effectively empty.

### `tests/unit/data/schema/test_schema_confidence_and_json.py`
- Purpose: Tests confidence score range and JSON validation constraints.
- Helpers: `has_json1_support`
- Tests:
  **TestConfidenceScoreRange**
  - `test_confidence_score_boundaries` - Test confidence_score boundary values.
  - `test_confidence_score_out_of_range` - Test confidence_score values outside 0-1 range.

  **TestJSONConstraints**
  - `test_json_valid_constraint` - Test json_valid() constraint.
  - `test_json_type_object_constraint` - Test json_type() = 'object' constraint.

### `tests/unit/data/schema/test_schema_defaults_and_structure.py`
- Purpose: Tests database table structure, default values, and schema creation.
- Tests:
  **TestDefaultValues**
  - `test_session_default_reg` - Test session defaults to 'REG' when not specified.
  - `test_timestamp_defaults` - Test created_at_iso defaults to current timestamp.
  - `test_news_symbols_timestamp_default` - Test created_at_iso default for news_symbols table.

  **TestTableStructure**
  - `test_without_rowid_optimization` - All user tables use WITHOUT ROWID and required tables exist.

### `tests/unit/data/schema/test_schema_enums.py`
- Purpose: Tests enum value constraints and locks critical enum values against changes.
- Tests:
  **TestEnumValueLocks**
  - `test_session_enum_values_unchanged` - Lock Session enum values - these are stored in database.
  - `test_stance_enum_values_unchanged` - Lock Stance enum values - these are stored in database.
  - `test_analysis_type_enum_values_unchanged` - Lock AnalysisType enum values - these are stored in database.
  - `test_news_type_enum_values_unchanged` - Lock NewsType values - stored in database.
  - `test_urgency_enum_values_unchanged` - Lock Urgency enum values - for future database storage.
  - `test_last_seen_state_enum_values_unchanged` - Lock Provider/Stream/Scope enum values used in last_seen_state.

  **TestEnumConstraints**
  - `test_session_enum_values` - Test session IN ('REG', 'PRE', 'POST', 'CLOSED') constraint.
  - `test_stance_enum_values` - Test stance IN ('BULL', 'BEAR', 'NEUTRAL') constraint.
  - `test_analysis_type_enum_values` - Test analysis_type enum constraint.
  - `test_news_type_enum_values` - Test news_items.news_type constraint values.
  - `test_news_symbols_is_important_constraint` - Test news_symbols.is_important constraint allows NULL/0/1 only.
  - `test_last_seen_state_constraints` - Test last_seen_state provider/stream/scope CHECK constraints.

### `tests/unit/data/schema/test_schema_financial_values.py`
- Purpose: Tests financial value constraints for prices and decimal storage.
- Tests:
  **TestFinancialConstraints**
  - `test_price_must_be_positive` - Test price > 0 constraint in price_data.
  - `test_price_boundary_values` - Test price constraint with boundary values.
  - `test_holdings_quantity_positive` - Test quantity > 0 constraint in holdings.
  - `test_holdings_break_even_positive` - Test break_even_price > 0 constraint in holdings.
  - `test_holdings_total_cost_positive` - Test total_cost > 0 constraint in holdings.

  **TestVolumeConstraints**
  - `test_volume_non_negative` - Test volume >= 0 constraint in price_data.
  - `test_volume_null_allowed` - Test that NULL volume is allowed.

### `tests/unit/data/schema/test_schema_last_seen_state.py`
- Purpose: Schema checks for the last_seen_state watermark table.
- Tests:
  **TestLastSeenStateSchema**
  - `test_table_has_expected_columns` - Test table has expected columns.
  - `test_primary_key_enforces_uniqueness` - Test primary key enforces uniqueness.
  - `test_scope_check_constraint` - Test scope check constraint.

### `tests/unit/data/schema/test_schema_not_null.py`
- Purpose: Tests NOT NULL constraints for required database fields.
- Tests:
  **TestNotNullConstraints**
  - `test_news_items_required_fields` - Test NOT NULL constraints on news_items table.
  - `test_news_symbols_required_fields` - Test NOT NULL constraints on news_symbols table.
  - `test_price_data_required_fields` - Test NOT NULL constraints on price_data table.
  - `test_analysis_results_required_fields` - Test NOT NULL constraints on analysis_results table.
  - `test_holdings_required_fields` - Test NOT NULL constraints on holdings table.

### `tests/unit/data/schema/test_schema_primary_keys.py`
- Purpose: Tests primary key uniqueness constraints for all database tables.
- Tests:
  **TestPrimaryKeyConstraints**
  - `test_news_items_primary_key` - Test url primary key on news_items.
  - `test_news_symbols_composite_key` - Test (url, symbol) composite primary key on news_symbols.
  - `test_price_data_composite_key` - Test (symbol, timestamp_iso) composite primary key on price_data.
  - `test_analysis_results_composite_key` - Test (symbol, analysis_type) composite primary key on analysis_results.
  - `test_holdings_single_key` - Test symbol primary key on holdings.

### `tests/unit/data/storage/test_storage_analysis.py`
- Purpose: Tests analysis result storage operations and conflict resolution.
- Tests:
  **TestAnalysisResultUpsert**
  - `test_upsert_analysis_conflict_resolution` - Test ON CONFLICT DO UPDATE for analysis results
  - `test_upsert_analysis_auto_created_at` - Test automatic created_at when not provided

### `tests/unit/data/storage/test_storage_core.py`
- Purpose: Edge-case coverage for data.storage.storage_core.
- Helpers: `FakeConnection`
- Tests:
  - `test_connect_logs_when_foreign_keys_pragma_fails` - Test connect logs when foreign keys pragma fails.
  - `test_connect_logs_when_busy_timeout_pragma_fails` - Test connect logs when busy timeout pragma fails.
  - `test_connect_logs_when_wal_pragma_fails` - Test connect logs when WAL pragma fails.
  - `test_connect_logs_when_sync_pragma_fails` - Test connect logs when synchronous pragma fails.
  - `test_connect_sets_wal_and_synchronous` - Successful connect enforces WAL and synchronous=NORMAL.
  - `test_check_json1_support_returns_false_when_extension_missing` - Test check json1 support returns false when extension missing.
  - `test_init_database_raises_when_json1_missing` - Test init database raises when json1 missing.
  - `test_finalize_database_raises_when_path_missing` - Test finalize database raises when path missing.
  - `test_finalize_database_switches_to_delete_mode` - Test finalize database switches to delete mode.
  - `test_finalize_database_runs_checkpoint` - Finalize issues synchronous=FULL, checkpoint, and delete mode.

### `tests/unit/data/storage/test_storage_cutoff.py`
- Purpose: Tests cutoff/pagination logic for news and price data queries.
- Tests:
  **TestCutoffQueries**
  - `test_get_news_before_cutoff_filtering` - Test news retrieval with created_at cutoff filtering for LLM batch processing
  - `test_get_news_before_boundary_conditions` - Test get_news_before with boundary conditions using spaced items
  - `test_get_prices_before_cutoff_filtering` - Test price data retrieval with created_at cutoff filtering for LLM batch processing
  - `test_get_prices_before_boundary_conditions` - Test get_prices_before with boundary conditions using spaced items

### `tests/unit/data/storage/test_storage_db.py`
- Purpose: Tests database initialization and schema creation.
- Tests:
  **TestDatabaseInitialization**
  - `test_init_database_creates_schema` - Test database initialization creates all required tables
  - `test_schema_file_not_found_raises_error` - Test error when schema.sql resource is missing
  - `test_wal_mode_enabled` - Test WAL mode is properly enabled (requires file-backed DB)
  - `test_foreign_keys_enabled_by_default` - Canary: every test connection should enforce FK constraints.

### `tests/unit/data/storage/test_storage_db_context.py`
- Purpose: Tests for _cursor_context() internal database context manager.
- Tests:
  **TestCursorContext**
  - `test_cursor_context_commit_true_commits_on_success` - Test that commit=True (default) commits on successful operations
  - `test_cursor_context_commit_false_no_commit` - Test that commit=False does not commit changes
  - `test_cursor_context_rollback_on_exception` - Test that exceptions trigger rollback
  - `test_cursor_context_rollback_on_base_exception` - Test that BaseException (like SystemExit) also triggers rollback
  - `test_cursor_context_sets_row_factory` - Test that sqlite3.Row factory is set for dict-like access
  - `test_cursor_context_cleanup_on_cursor_error` - Test that connection cleanup happens even if cursor operations fail
  - `test_cursor_context_cleanup_in_finally` - Test that connection is always closed via finally block

### `tests/unit/data/storage/test_storage_errors.py`
- Purpose: Tests error handling and edge cases in storage operations.
- Tests:
  **TestErrorHandling**
  - `test_database_operations_with_nonexistent_db` - Test operations fail gracefully with non-existent database
  - `test_query_operations_with_empty_database` - Test query operations return empty results with empty database

### `tests/unit/data/storage/test_storage_holdings.py`
- Purpose: Tests holdings storage operations and upsert logic.
- Tests:
  **TestHoldingsUpsert**
  - `test_upsert_holdings_timestamp_handling` - Test holdings upsert preserves created_at, updates updated_at
  - `test_upsert_holdings_auto_timestamps` - Test automatic timestamp generation when not provided

### `tests/unit/data/storage/test_storage_llm_batch.py`
- Purpose: Tests LLM batch operation storage and commit functionality.
- Helpers: `_get_created_at`
- Tests:
  **TestBatchOperations**
  - `test_commit_llm_batch_atomic_transaction` - commit_llm_batch prunes rows <= cutoff and returns counts.
  - `test_commit_llm_batch_empty_database` - Empty database should still set watermark and delete nothing.
  - `test_commit_llm_batch_boundary_conditions` - Rows with created_at <= cutoff are deleted (inclusive boundary).
  - `test_commit_llm_batch_idempotency` - Repeated calls with same cutoff delete only once.

### `tests/unit/data/storage/test_storage_news.py`
- Purpose: Tests news item storage operations and symbol link persistence.
- Tests:
  **TestNewsItemStorage**
  - `test_store_news_deduplication_insert_or_ignore` - News entries sharing a normalized URL deduplicate into one article row.
  - `test_store_news_empty_list_no_error` - Storing an empty list is a no-op.

  **TestNewsSymbolsStorage**
  - `test_store_and_get_news_symbols` - Persist entries with varying importance flags and round-trip via facade.
  - `test_get_news_symbols_filters_by_symbol` - Filtering by symbol returns only matching links.
  - `test_news_symbols_cascade_on_news_deletion` - Deleting a news_items row cascades to news_symbols.
  - `test_store_news_symbols_conflict_updates_is_important` - Conflict updates mutate importance flags without duplicating rows.

### `tests/unit/data/storage/test_storage_prices.py`
- Purpose: Tests price data storage operations and type handling.
- Tests:
  **TestPriceDataStorage**
  - `test_store_price_data_type_conversions` - Test price data storage with Decimal and enum conversions
  - `test_store_price_data_deduplication` - Test price data deduplication on (symbol, timestamp) key

### `tests/unit/data/storage/test_storage_queries.py`
- Purpose: Tests data retrieval queries and filtering logic.
- Tests:
  **TestQueryOperations**
  - `test_get_news_since_timestamp_filtering` - Test news retrieval with timestamp filtering
  - `test_get_price_data_since_ordering` - Test price data retrieval with proper ordering
  - `test_get_all_holdings_ordering` - Test holdings retrieval with symbol ordering
  - `test_get_analysis_results_symbol_filtering` - Test analysis results retrieval with optional symbol filtering

### `tests/unit/data/storage/test_storage_social.py`
- Purpose: Social discussion storage CRUD tests.
- Tests:
  **TestStoreSocialDiscussions**
  - `test_store_social_discussions_inserts` - Unique (source, source_id) rows insert with normalized fields.
  - `test_store_social_discussions_upserts_on_source_id` - Upsert updates fields when source/source_id conflict.
  - `test_store_social_discussions_empty_list_noop` - Empty input performs no inserts.

  **TestGetSocialDiscussions**
  - `test_get_social_discussions_since_filters_by_timestamp` - Returns only rows after cutoff.
  - `test_get_social_discussions_since_filters_by_symbol_case_insensitive` - Symbol filter uppercases input before lookup.
  - `test_get_social_discussions_since_sorted_ascending` - Rows are ordered by published_iso ascending.
  - `test_store_and_get_preserves_content_and_url_normalization` - Content round-trips; URLs are normalized on insert.

### `tests/unit/data/storage/test_storage_types.py`
- Purpose: Tests type conversion helper functions (_datetime_to_iso, _decimal_to_text).
- Tests:
  **TestTypeConversions**
  - `test_datetime_to_iso_format_utc_aware` - Test UTC-aware datetime conversion to ISO format
  - `test_datetime_to_iso_format_naive` - Test naive datetime conversion to ISO format (treated as UTC)
  - `test_datetime_to_iso_strips_microseconds` - Test microseconds are stripped from datetime
  - `test_decimal_to_text_precision_preservation` - Test Decimal to TEXT preserves exact precision

### `tests/unit/data/storage/test_storage_url.py`
- Purpose: Tests URL normalization and deduplication logic for news items.
- Tests:
  **TestURLNormalization**
  - `test_normalize_url_strips_tracking_parameters` - Test removal of common tracking parameters (case-insensitive)
  - `test_normalize_url_preserves_essential_parameters` - Test non-tracking parameters are preserved
  - `test_normalize_url_canonical_ordering` - Test consistent parameter ordering
  - `test_normalize_url_mixed_tracking_and_essential` - Test mixed tracking and essential parameters
  - `test_normalize_url_lowercases_hostname` - Test hostname is lowercased for consistent deduplication

### `tests/unit/data/storage/test_storage_utils_parsing.py`
- Purpose: Tests for storage_utils parsing and row conversion helpers.
- Tests:
  **TestIsoParsingHelpers**
  - `test_iso_to_datetime_parses_z_suffix` - Test iso to datetime parses z suffix.
  - `test_iso_to_datetime_preserves_offset` - Test iso to datetime preserves offset.

  **TestRowMappers**
  - `test_row_to_news_item_maps_fields_and_type` - Test row to news item maps fields and type.
  - `test_row_to_news_symbol_maps_fields_and_nullable_is_important` - Test row to news symbol maps fields and nullable is important.
  - `test_row_to_news_entry_maps_joined_row` - Test row to news entry maps joined row.
  - `test_row_to_price_data_maps_decimal_and_session` - Test row to price data maps decimal and session.
  - `test_row_to_analysis_result_builds_model` - Test row to analysis result builds model.
  - `test_row_to_holdings_parses_decimals` - Test row to holdings parses decimals.

### `tests/unit/data/storage/test_storage_watermark.py`
- Purpose: Typed watermark storage helpers for last_seen_state.
- Tests:
  **TestTimestampCursors**
  - `test_global_timestamp_roundtrip` - Test global timestamp roundtrip.
  - `test_symbol_timestamp_roundtrip` - Test symbol timestamp roundtrip.
  - `test_timestamp_upsert_is_monotonic` - Newer timestamps stick; older writes ignored.

  **TestSymbolNormalization**
  - `test_symbol_scope_requires_non_empty_value` - Test symbol scope requires non empty value.
  - `test_global_scope_rejects_symbols` - Test global scope rejects symbols.

  **TestIdCursors**
  - `test_global_id_roundtrip` - Test global id roundtrip.
  - `test_corrupted_id_row_returns_none` - Test corrupted id row returns none.
  - `test_id_upsert_is_monotonic` - Newer IDs replace older; older writes ignored.

  **TestSchemaConstraints**
  - `test_xor_constraint_blocks_timestamp_and_id` - Cannot store both timestamp and id in same row.
  - `test_global_scope_defaults_symbol_to_global` - Global scope writes store the __GLOBAL__ sentinel.

### `tests/unit/data/test_data_base.py`
- Purpose: Contract tests for data provider ABCs and exceptions.
- Tests:
  **TestDataSourceContract**
  - `test_source_name_none_raises` - Test source name none raises.
  - `test_source_name_must_be_string` - Test source name must be string.
  - `test_source_name_cannot_be_empty` - Test source name cannot be empty.
  - `test_source_name_length_limit` - Test source name length limit.
  - `test_source_name_normalization` - Test source name normalization.
  - `test_datasource_is_abstract` - Test datasource is abstract.

  **TestNewsDataSourceContract**
  - `test_requires_fetch_incremental` - Test requires fetch incremental.
  - `test_concrete_implementation_satisfies_contract` - Test concrete implementation satisfies contract.

  **TestPriceDataSourceContract**
  - `test_requires_fetch_incremental` - Test requires fetch incremental.
  - `test_concrete_implementation_satisfies_contract` - Test concrete implementation satisfies contract.

  **TestDataSourceErrorContract**
  - `test_exception_inheritance` - Test exception inheritance.

  **TestSocialDataSourceContract**
  - `test_requires_fetch_incremental` - SocialDataSource must define fetch_incremental.
  - `test_concrete_implementation_satisfies_contract` - Concrete implementation accepts optional cursors.

### `tests/unit/llm/providers/test_gemini_provider.py`
- Purpose: Unit tests for the Gemini LLM provider.
- Tags: [async]
- Helpers: `_make_provider`, `_TestAPIError`, `_TestServerError`, `_TestClientError`, `_api_error`, `_server_error`, `_client_error`
- Tests:
  **TestGeminiProvider**
  - `test_generate_maps_tool_choice` - Test generate maps tool choice.
  - `test_generate_requires_tools_for_any` - Test generate requires tools for any.
  - `test_generate_rejects_tool_choice_without_function_declarations` - tool_choice with only built-in tools (code_execution) should raise ValueError.
  - `test_generate_uses_default_thinking` - Test generate uses default thinking.
  - `test_generate_uses_custom_thinking` - Test generate uses custom thinking.
  - `test_generate_clamps_small_thinking_budget` - Budgets below 128 should be clamped up to 128.
  - `test_generate_raises_when_no_candidates` - Test generate raises when no candidates.
  - `test_generate_combines_text_and_code_outputs` - Test generate combines text and code outputs.
  - `test_generate_handles_none_code_output` - Test generate handles none code output.
  - `test_validate_connection_failure` - Test validate connection failure.
  - `test_classify_server_error` - Test classify server error.
  - `test_classify_api_error_codes` - Test classify api error codes.
  - `test_classify_api_error_rate_limit_uses_retry_after` - Test classify api error rate limit uses retry after.
  - `test_classify_client_error` - Test classify client error.
  - `test_classify_timeout_message` - Test classify timeout message.
  - `test_classify_connection_message` - Test classify connection message.
  - `test_classify_unexpected_error` - Test classify unexpected error.

### `tests/unit/llm/providers/test_openai_provider.py`
- Purpose: Unit tests for the OpenAI LLM provider.
- Tags: [async]
- Helpers: `_make_provider`, `_dummy_request`, `_status_response`
- Tests:
  **TestOpenAIProvider**
  - `test_generate_passes_expected_args` - Test generate passes expected args.
  - `test_generate_respects_custom_reasoning` - Test generate respects custom reasoning.
  - `test_generate_coerces_gpt5_tool_choice_to_auto` - Test generate coerces gpt5 tool choice to auto.
  - `test_classify_rate_limit_with_retry_after` - Test classify rate limit with retry after.
  - `test_classify_rate_limit_without_retry_after` - Test classify rate limit without retry after.
  - `test_classify_retryable_errors` - Test classify retryable errors.
  - `test_classify_api_status_retryable` - Test classify api status retryable.
  - `test_classify_api_status_rate_limit` - Test classify api status rate limit.
  - `test_classify_api_status_non_retryable` - Test classify api status non retryable.
  - `test_classify_non_retryable_openai_errors` - Test classify non retryable openai errors.
  - `test_classify_falls_back_to_llm_error` - Test classify falls back to llm error.
  - `test_validate_connection_failure` - Test validate connection failure.

### `tests/unit/llm/test_llm_base.py`
- Purpose: LLM provider base class contracts and exceptions.
- Tests:
  **TestLLMProviderInitialization**
  - `test_llmprovider_stores_config_kwargs` - Test that __init__ stores arbitrary kwargs in config

  **TestAbstractMethodEnforcement**
  - `test_llmprovider_cannot_instantiate` - Test that LLMProvider ABC cannot be instantiated directly
  - `test_llmprovider_requires_generate` - Test that subclass without generate() cannot be instantiated
  - `test_llmprovider_requires_validate_connection` - Test that subclass without validate_connection() cannot be instantiated
  - `test_concrete_implementation_works` - Test that complete implementation can be instantiated

  **TestExceptionHierarchy**
  - `test_llm_error_inheritance` - Test that LLMError inherits from Exception

### `tests/unit/utils/test_datetime_utils.py`
- Purpose: Tests for utils/datetime_utils.py.
- Tests:
  **TestNormalizeToUtc**
  - `test_naive_datetime_is_assumed_utc` - Naive datetimes are treated as UTC.
  - `test_aware_datetime_is_converted_to_utc` - Aware datetimes are converted to UTC.

  **TestEpochSecondsToUtcDatetime**
  - `test_epoch_zero_is_utc` - Epoch 0 maps to UTC 1970-01-01.
  - `test_epoch_float_is_utc` - Float epoch seconds convert to a UTC datetime.
  - `test_non_numeric_raises` - Non-numeric epoch inputs raise TypeError.

### `tests/unit/utils/test_http.py`
- Purpose: HTTP retry helper behaviors for utils.http.get_json_with_retry.
- Tags: [async]
- Tests:
  **TestGetJsonWithRetry**
  - `test_200_ok_valid_json` - Test 200 OK with valid JSON returns parsed object
  - `test_200_ok_invalid_json` - Test 200 OK with invalid JSON raises DataSourceError without retry
  - `test_204_no_content` - Test 204 No Content returns None
  - `test_401_403_auth_errors` - Test 401/403 auth errors raise DataSourceError without retry
  - `test_other_4xx_errors` - Test other 4xx errors (e.g., 404) raise DataSourceError without retry
  - `test_408_request_timeout_is_retryable` - HTTP 408 should be treated as retryable and honor Retry-After
  - `test_429_numeric_retry_after` - Test 429 with numeric Retry-After header
  - `test_429_http_date_retry_after` - Test 429 with HTTP-date Retry-After header
  - `test_5xx_server_errors` - Test 5xx server errors trigger retries
  - `test_5xx_max_retries_exhausted` - Test that last RetryableError is raised after max attempts
  - `test_timeout_exception` - Test httpx.TimeoutException triggers retry
  - `test_transport_error` - Test httpx.TransportError triggers retry
  - `test_query_params_passed_through` - Test that query params are passed through unchanged
  - `test_timeout_arg_is_forwarded` - Test that timeout parameter is forwarded to AsyncClient
  - `test_unexpected_status_raises` - Test that unexpected status codes raise DataSourceError

### `tests/unit/utils/test_market_sessions.py`
- Purpose: US market session detection based on Eastern Time (ET).
- Tests:
  **TestClassifyUsSession**
  - `test_core_windows` - Test core market windows across EDT and EST timezones.
  - `test_exact_boundaries_and_precision` - Test precise session boundaries including microsecond precision.
  - `test_dst_transitions` - Test DST transitions maintain correct ET-based session classification.
  - `test_weekends_holidays_early_closes` - Test weekends, major holidays, and early close days.
  - `test_input_tz_handling` - Test handling of different timezone inputs (naive, ET, UTC).
  - `test_same_utc_time_diff_seasons` - Test same UTC time yields different sessions in EDT vs EST.
  - `test_close_time_lookup_failure_falls_back_to_16_et_and_logs_warning` - Test graceful degradation when NYSE calendar close time lookup fails

### `tests/unit/utils/test_retry.py`
- Purpose: Retry utilities behaviors relied on by core workflows.
- Tags: [async]
- Tests:
  **TestParseRetryAfter**
  - `test_numeric_seconds` - Test parsing numeric seconds
  - `test_numeric_zero_values` - Numeric zero inputs should be honored, not treated as missing
  - `test_numeric_negative_floored` - Test negative values are floored to 0
  - `test_http_date_future` - Test HTTP-date parsing for future dates
  - `test_http_date_past` - Test HTTP-date parsing for past dates (floored to 0)
  - `test_invalid_header` - Test invalid header returns None
  - `test_invalid_retry_after_values_log_warning_and_return_none` - Test graceful handling of malformed Retry-After headers with logging

  **TestRetryAndCall**
  - `test_retry_after_honored` - Test that Retry-After is honored over exponential backoff
  - `test_exponential_backoff` - Test exponential backoff when no retry_after
  - `test_exponential_backoff_with_jitter` - Test that jitter is applied to exponential backoff
  - `test_gives_up_and_surfaces_last_error` - Test that last exception is propagated after max attempts
  - `test_success_on_first_attempt` - Test immediate success without retries
  - `test_non_retryable_error_propagates` - Test that non-RetryableError exceptions are not retried
  - `test_retryable_then_non_retryable_error` - Test retryable error followed by non-retryable error stops immediately

### `tests/unit/utils/test_symbols.py`
- Purpose: Symbols parsing and filtering via parse_symbols().
- Tests:
  **TestParseSymbols**
  - `test_basic_trim_uppercase_order_preserving_dedupe` - Test core parsing: trim, uppercase, dedupe while preserving order
  - `test_filter_to_watchlist` - Test watchlist filtering keeps only allowed symbols
  - `test_validation_toggle_true_skips_false_keeps` - Test validation on/off behavior
  - `test_fail_on_invalid_true_returns_empty_list` - When fail_on_invalid=True, any invalid token invalidates the whole list.
  - `test_empty_input_returns_empty_list` - Test graceful handling of empty/null inputs
  - `test_mixed_valid_invalid_tokens_logs_when_validate_true` - Test logging behavior for invalid symbols during validation
  - `test_share_class_and_suffix_symbols_allowed` - Share-class suffixes (dot/dash) and digits after first char should be accepted.

  **TestNormalizeSymbolList**
  - `test_trim_uppercase_drop_empty_preserve_order` - Trims, uppercases, and drops empty entries while preserving order.
  - `test_does_not_dedupe` - Does not remove duplicates (providers may want repeated symbols).

### `tests/unit/workflows/test_poller.py`
- Purpose: DataPoller orchestrator: one-cycle behavior and watermarks.
- Tags: [async]
- Fixtures:
  - `immediate_to_thread` - Patch asyncio.to_thread to run callables synchronously in tests.
- Helpers: `StubNews`, `StubPrice`, `SecondaryStubPrice`, `StubMacroNews`, `StubSocial`
- Tests:
  **TestDataPoller**
  - `test_poll_once_collects_errors` - Collect provider errors while still processing other successful providers.
  - `test_poller_quick_shutdown` - Stop the run loop quickly instead of waiting the full poll interval.
  - `test_poller_custom_poll_interval` - Respect a custom poll interval configuration on the poller.
  - `test_poll_once_collects_price_provider_errors` - Collect price provider errors and surface them in stats.
  - `test_fetch_all_data_forwards_cursor_kwargs` - Forward watermark cursor fields into provider.fetch_incremental keyword args.
  - `test_fetch_all_data_routes_company_and_macro_news` - Test fetch all data routes company and macro news.
  - `test_fetch_all_data_handles_social_providers` - Social providers receive cursor kwargs and errors are collected.
  - `test_poll_once_logs_no_price_data` - Empty price payload logs a notice.
  - `test_poll_once_includes_social_stats` - Poll stats include social count and surfaced errors.
  - `test_poll_once_catches_cycle_error_and_appends` - Top-level exceptions are caught and surfaced via stats.

  **TestDataPollerProcessPrices**
  - `test_process_prices_returns_zero_on_empty_input` - Test process prices returns zero on empty input.
  - `test_process_prices_primary_missing_symbol_warns_and_skips` - Test process prices primary missing symbol warns and skips.
  - `test_process_prices_missing_secondary_provider_is_ignored` - Test process prices missing secondary provider is ignored.
  - `test_process_prices_secondary_missing_symbol_warns` - Test process prices secondary missing symbol warns.
  - `test_process_prices_mismatch_logs_error_and_keeps_primary` - Test process prices mismatch logs error and keeps primary.
  - `test_process_prices_handles_duplicate_class_instances` - Test process prices handles duplicate class instances.

  **TestDataPollerSocialProcessing**
  - `test_process_social_stores_and_commits` - Stores social discussions and commits watermarks.
  - `test_process_social_logs_when_empty` - Empty social list logs a notice and returns zero.

  **TestDataPollerNewsProcessing**
  - `test_process_news_commits_each_provider` - Test process news commits each provider.
  - `test_process_news_logs_urgency_detection_failures` - Test process news logs urgency detection failures.
  - `test_process_news_logs_when_empty` - Test process news logs when empty.
  - `test_process_news_labels_importance_before_store` - News entries are marked important by the importance stub before storage.
  - `test_log_urgent_items_logs_summary` - Test log urgent items logs summary.
  - `test_process_social_logs_urgency_detection_failures` - Test process social logs urgency detection failures.
  - `test_log_urgent_social_logs_summary` - Test log urgent social items logs summary.

  **TestDataPollerRunLoop**
  - `test_run_logs_completed_with_errors` - Test run logs completed with errors.
  - `test_run_skips_wait_when_sleep_time_zero` - Test run skips wait when sleep time zero.
  - `test_run_handles_wait_timeout` - Test run handles wait timeout.
  - `test_run_handles_wait_cancelled` - Test run handles wait cancelled.

### `tests/unit/workflows/test_watermarks.py`
- Purpose: Unit tests for the WatermarkEngine (planning + commit behavior).
- Helpers: `_make_engine`
- Tests:
  **TestWatermarkEngine**
  - `test_build_plan_finnhub_macro_uses_id_cursor` - Build plan uses the stored macro ID watermark as min_id.
  - `test_build_plan_finnhub_company_maps_each_symbol` - Build plan returns a per-symbol timestamp map for Finnhub company news.
  - `test_build_plan_reddit_social_uses_per_symbol_map` - Build plan omits new symbols for Reddit so provider can bootstrap.
  - `test_commit_updates_symbol_scope_clamps_future` - Commit updates clamps future timestamps for per-symbol streams.
  - `test_commit_updates_id_scope_writes_last_fetched_max` - Commit updates persists last_fetched_max_id for ID-based streams.
  - `test_commit_updates_id_scope_noop_without_last_fetched` - Commit updates does nothing when last_fetched_max_id is missing.
  - `test_commit_updates_social_scope_commits_per_symbol_and_clamps_future` - Commit updates tracks Reddit social timestamps per symbol and clamps future.
  - `test_get_settings_missing_attribute_raises` - _get_settings raises when provider has no settings attribute.

### `tests/unit/workflows/test_watermarks_functions.py`
- Purpose: Unit tests for pure helper functions in workflows.watermarks.
- Tests:
  - `test_is_macro_stream_matches_rule` - is_macro_stream is True only for providers configured as macro stream.
